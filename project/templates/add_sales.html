{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% if edit_mode %}Edit Sale{% else %}Add Sale{% endif %}</title>
  <link rel="stylesheet" href="{% static 'sales.css' %}">
<style>
/* ===== General Page Layout ===== */
body {
    font-family: "Poppins", sans-serif;
    background: linear-gradient(135deg, #f0f4f7, #e4e9ed);
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
}

/* ===== Container ===== */
.container {
    background: #fff;
    padding: 40px 50px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 960px; /* previously 420px */
    margin-top: 40px;
}


/* ===== Header ===== */
h2 {
    margin-bottom: 25px;
    color: #333;
    font-size: 26px;
    text-align: center;
}

/* ===== Form Styling ===== */
form {
    text-align: left;
}

form p {
    margin-bottom: 15px;
}

label {
    font-weight: 600;
    display: block;
    margin-bottom: 6px;
    color: #444;
}

/* ===== Inputs ===== */
input[type="text"],
input[type="number"],
select,
textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 15px;
    transition: all 0.3s ease;
}

input:focus,
select:focus,
textarea:focus {
    border-color: #4CAF50;
    outline: none;
    box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
}

/* ===== Table Styling ===== */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 14px;
}

th, td {
    padding: 10px;
    min-width: 100px;
    border: 1px solid #ddd;
    text-align: center;
    vertical-align: middle;
}

thead {
    background-color: #f0f4f7;
}

tr:nth-child(even) {
    background-color: #fafafa;
}

tr:hover {
    background-color: #f1f9ff;
}

.line-total {
    background-color: #f9f9f9;
    border: none;
    font-weight: bold;
    text-align: right;
}

/* ===== Buttons ===== */
button[type="submit"],
.btn-success {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 12px 20px;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: 0.3s ease;
    margin-top: 20px;
    width: 100%;
}

button[type="submit"]:hover,
.btn-success:hover {
    background: #45a049;
}

button[type="button"],
.btn-add {
    background: #2196f3;
    color: white;
    border: none;
    padding: 10px 16px;
    font-size: 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: 0.3s ease;
    margin-top: 10px;
}

button[type="button"]:hover,
.btn-add:hover {
    background: #1976d2;
}

.back-btn {
    display: inline-block;
    background: #f44336;
    color: #fff;
    padding: 10px 18px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 14px;
    transition: 0.3s ease;
    margin-top: 20px;
}

.back-btn:hover {
    background: #d32f2f;
}

/* ===== Grand Total Section ===== */
#grand_total {
    width: 100%;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    padding: 12px;
    border: 2px solid #4CAF50;
    border-radius: 6px;
    background-color: #f0f4f7;
    color: #2e7d32;
    box-sizing: border-box;
}


/* ===== Item Row Inputs ===== */
.item-row td {
    padding: 8px;
    vertical-align: middle;
}

.item-row select,
.item-row input[type="number"] {
    width: 100%;
    padding: 8px 10px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-sizing: border-box;
    background-color: #fff;
    transition: border-color 0.3s ease;
}

.item-row input[type="number"]:focus,
.item-row select:focus {
    border-color: #4CAF50;
    outline: none;
    box-shadow: 0 0 4px rgba(76, 175, 80, 0.3);
}

/* ===== Total Field in Row ===== */
.line-total {
    background-color: #f9f9f9;
    border: none;
    font-weight: bold;
    text-align: right;
    padding: 8px 10px;
    color: #333;
}

/* ===== Popup Messages ===== */
.popup-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
}

.popup-message {
    padding: 12px 20px;
    border-radius: 6px;
    margin-bottom: 10px;
    color: white;
    animation: fadeInOut 3s ease forwards;
}

.popup-message.success { background: #4CAF50; }
.popup-message.error { background: #f44336; }
.popup-message.warning { background: #ff9800; }
.popup-message.info { background: #2196f3; }

@keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(-20px); }
    10% { opacity: 1; transform: translateY(0); }
    90% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-20px); }
}
</style>
</head>
<body>

<div class="container mt-4">
  <h2>{% if edit_mode %}Edit Sale{% else %}Add Sale{% endif %}</h2>

  <form method="post" id="salesForm">
    {% csrf_token %}

    <div style="display: flex; gap: 40px; margin-bottom: 20px;">
      <div style="flex: 1;">
        <label>Bill Number:</label>
        <input type="text" value="{{ bill_number }}" readonly>
      </div>
      <div style="flex: 1;">
        <label>Date:</label>
        <input type="text" value="{{ bill_date }}" readonly>
      </div>
    </div>

    {{ form.as_p }}

    <h4>Items</h4>
    {{ formset.management_form }}
    <table class="table" id="item-table">
      <thead>
        <tr>
          <th>Item</th>
          <th>Qty</th>
          <th>Rate</th>
          <th>Discount</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="formset-body">
        {% for form in formset %}
        <tr class="item-row">
            {% for hidden in form.hidden_fields %}
            {{ hidden }}
            {% endfor %}
            <td>{{ form.item }}</td>
            <td>{{ form.quantity }}</td>
            <td>{{ form.rate }}</td>
            <td>{{ form.discount }}</td>
            <td><input type="number" class="line-total form-control" readonly></td>
        </tr>
          {% for field in form.visible_fields %}
            {% if field.errors %}
              <tr>
                <td colspan="5" class="error">
                  <strong>{{ field.label }}:</strong> {{ field.errors|join:", " }}
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        {% endfor %}
      </tbody>
    </table>

    {% if formset.non_form_errors %}
      <div class="error">
        {{ formset.non_form_errors }}
      </div>
    {% endif %}

    <button type="button" class="btn btn-add" onclick="addItemRow()">âž• Add Item</button>

    <div style="margin-top: 20px;">
      <label>Grand Total:</label>
      <input type="number" id="grand_total" readonly>
    </div>

    <button type="submit" class="btn btn-submit">ðŸ’¾ Save</button>
    <a href="{% url 'sales_list' %}" class="btn">â¬… Back</a>
  </form>

  <div id="item-data" data-items="{% for item in items %}{{ item.id }}|{{ item.price }}|{{ item.quantity }}|{{ item.name }};{% endfor %}"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const raw = document.getElementById('item-data').dataset.items;
  const items = {};
  raw.split(';').filter(Boolean).forEach(row => {
    const [id, price, stock, name] = row.split('|');
    items[id] = {
      price: parseFloat(price),
      stock: parseInt(stock),
      name: name
    };
  });

  function updateRow(row) {
    const itemSelect = row.querySelector('select[name$="-item"]');
    const qtyInput = row.querySelector('input[name$="-quantity"]');
    const rateInput = row.querySelector('input[name$="-rate"]');
    const discountInput = row.querySelector('input[name$="-discount"]');
    const totalField = row.querySelector('.line-total');

    const selectedId = itemSelect?.value;
    const item = items[selectedId];
    const qty = parseInt(qtyInput?.value) || 0;
    const discount = parseFloat(discountInput?.value) || 0;

    if (item) {
      rateInput.value = item.price.toFixed(2);
      if (qty > item.stock) {
        alert(`âš  Only ${item.stock} units available!`);
        qtyInput.value = item.stock;
      }

      const subtotal = item.price * qty;
      const discountAmount = subtotal * (discount / 100);
      const total = subtotal - discountAmount;
      totalField.value = total.toFixed(2);
    } else {
      rateInput.value = '';
      totalField.value = '';
    }

    updateGrandTotal();
  }

  function updateGrandTotal() {
    let total = 0;
    document.querySelectorAll('.line-total').forEach(input => {
      total += parseFloat(input.value) || 0;
    });
    const grandTotal = document.getElementById('grand_total');
    if (grandTotal) grandTotal.value = total.toFixed(2);
  }

  function bindRowEvents(row) {
    const itemSelect = row.querySelector('select[name$="-item"]');
    const qtyInput = row.querySelector('input[name$="-quantity"]');
    const discountInput = row.querySelector('input[name$="-discount"]');

    if (itemSelect) {
      itemSelect.addEventListener('change', () => updateRow(row));
      if (itemSelect.value) updateRow(row);
    }

    if (qtyInput) {
      qtyInput.addEventListener('input', () => updateRow(row));
      qtyInput.addEventListener('change', () => updateRow(row));
    }

    if (discountInput) {
      discountInput.addEventListener('input', () => updateRow(row));
      discountInput.addEventListener('change', () => updateRow(row));
    }
  }

  document.querySelectorAll('.item-row').forEach(row => {
    bindRowEvents(row);
    updateRow(row);
  });

  window.addItemRow = function () {
    const formsetBody = document.getElementById('formset-body');
    const totalForms = document.getElementById('id_form-TOTAL_FORMS');
    const newIndex = parseInt(totalForms.value);

    const row = document.createElement('tr');
    row.classList.add('item-row');

    const options = Object.entries(items).map(([id, data]) =>
      `<option value="${id}">${data.name}</option>`
    ).join('');

    row.innerHTML = `
  <input type="hidden" name="form-${newIndex}-id" id="form-${newIndex}-id">
  <td>
    <select name="form-${newIndex}-item" class="form-control">
      <option value="">---------</option>
      ${options}
    </select>
  </td>
  <td><input type="number" name="form-${newIndex}-quantity" value="0" class="form-control"></td>
  <td><input type="number" name="form-${newIndex}-rate" readonly class="form-control"></td>
  <td><input type="number" name="form-${newIndex}-discount" value="0" class="form-control"></td>
  <td><input type="number" class="line-total form-control" readonly></td>
`;


    formsetBody.appendChild(row);
    totalForms.value = newIndex + 1;

    bindRowEvents(row);
    updateRow(row);
    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
  };
});
</script>

</body>
</html>
